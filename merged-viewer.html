<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>DINI (most recent forecast)</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js"></script>
  <style>
    :root {
      --panel-bg: rgba(255,255,255,0.96);
      --border: #ccc;
      --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji", "Segoe UI Symbol";
    }
    html, body { height: 100%; }
    body { margin:0; padding:0; font-family: var(--font); }
    #map { position:absolute; inset:0; }
    .panel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: var(--panel-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
      display: grid;
      grid-template-columns: auto auto;
      gap: 6px 10px;
      align-items: center;
    }
    .panel label { font-size: 12px; color: #333; }
    .panel input[type="datetime-local"],
    .panel input[type="text"],
    .panel input[type="number"],
    .panel select,
    .panel button {
      font-size: 12px;
      padding: 6px 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: white;
    }
    .row-span-2 { grid-row: span 2; }
    .col-span-2 { grid-column: 1 / -1; }
    .btn {
      cursor: pointer;
      user-select: none;
    }
    .btn:hover { background: #f5f5f5; }
    .right-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: var(--panel-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .hint { font-size: 11px; color: #666; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel" id="control-panel">
    <label for="backend">Backend</label>
    <select id="backend">
      <option value="wms">WMS</option>
      <option value="tiles">Tiles</option>
    </select>

    <label for="variable">Variable</label>
    <select id="variable">
      <option value="t2m" selected>t2m (temperature @ 2m)</option>
      <option value="ws10m">ws10m (windspeed @ 10m)</option>
      <option value="u10m">u10m (zonal wind @ 10m)</option>
      <option value="v10m">v10m (meridional wind @ 10m)</option>
    </select>

    <label for="colormap">Colormap</label>
    <select id="colormap">
      <option value="temperature_colors">temperature_colors</option>
      <option value="viridis" selected>viridis</option>
      <option value="plasma">plasma</option>
      <option value="inferno">inferno</option>
      <option value="magma">magma</option>
      <option value="cividis">cividis</option>
      <option value="hsv">hsv</option>
      <option value="coolwarm">coolwarm</option>
      <option value="bwr">bwr</option>
    </select>

    <label for="vmin">vmin</label>
    <input id="vmin" type="number" step="any" value="280" />

    <label for="vmax">vmax</label>
    <input id="vmax" type="number" step="any" value="300" />

    <label for="time">valid_time</label>
    <input id="time" type="datetime-local" />

    <div class="col-span-2">
      <button id="back3" class="btn">&larr; 3h</button>
      <button id="fwd3" class="btn">3h &rarr;</button>
      <span class="hint">Times use your local time, aligned to 3-hour steps.</span>
    </div>

    <label for="opacity">Opacity</label>
    <input id="opacity" type="range" min="0" max="1" step="0.01" value="0.6" />
  </div>

  <div class="right-panel">
    <button id="tile-boundaries" class="btn">Show tile boundaries</button>
  </div>

  <script>
    // Mapbox token (replace if needed)
    mapboxgl.accessToken = 'pk.eyJ1IjoibXBpYW5udWNjaSIsImEiOiJja3FiZHg2emEwMGNjMndvY2F6OTdpcWN3In0.rjzyODwHa4rsEy2CH7IDwQ';

    // Host & endpoints
    const HOST = 'dini-to-zarr.dmidev.org:8080';

    // Helpers for local-time-safe parsing/formatting
    const pad = (n) => String(n).padStart(2, '0');

    // Parse "YYYY-MM-DDTHH:mm" or "YYYY-MM-DDTHH:mm:ss" as LOCAL time
    const parseLocal = (s) => {
      const [datePart, timePart = "00:00:00"] = s.split('T');
      const [y, m, d] = datePart.split('-').map(Number);
      const [hh, mm, ss = 0] = timePart.split(':').map(Number);
      return new Date(y, (m - 1), d, hh, mm, ss, 0); // Local Date
    };

    // Format to "YYYY-MM-DDTHH:mm" for input
    const fmtLocalMinute = (d) =>
      `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;

    // Format to "YYYY-MM-DDTHH:mm:ss" for server params
    const fmtLocalSecond = (d) =>
      `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;

    // Align to nearest previous 3h bin and then shift by delta (+/-3)
    const align3h = (d, deltaHours) => {
      const h = d.getHours();
      const base = Math.floor(h / 3) * 3 + deltaHours;
      const out = new Date(d);
      out.setHours(base, 0, 0, 0);
      return out;
    };
    
    // compute default valid_time as nearest past 3h aligned local time
    const now = new Date();
    const defaultValidTime = align3h(now, 0);

    // Default state
    let state = {
      backend: 'wms',          // 'wms' | 'tiles'
      variable: 't2m',
      colormap: 'temperature_colors',
      vmin: -20,
      vmax: 20,
      valid_time: fmtLocalSecond(defaultValidTime) // "YYYY-MM-DDTHH:mm:ss"
    };

    // DOM
    const elBackend  = document.getElementById('backend');
    const elVar      = document.getElementById('variable');
    const elCmap     = document.getElementById('colormap');
    const elVmin     = document.getElementById('vmin');
    const elVmax     = document.getElementById('vmax');
    const elTime     = document.getElementById('time');
    const elBack3    = document.getElementById('back3');
    const elFwd3     = document.getElementById('fwd3');
    const elOpacity  = document.getElementById('opacity');
    const elTileBtn  = document.getElementById('tile-boundaries');

    // Initialize input values
    const initTime = () => {
      // If empty, initialize to current local time aligned to previous 3h
      // const now = new Date();
      // const prev = align3h(now, 0); // align to prev multiple-of-3
      // state.valid_time = fmtLocalSecond(prev);
      // elTime.value = fmtLocalMinute(prev);
      // if empty, initialize to state to valid_time (1990-09-01T03:00:00)
      elTime.value = state.valid_time.slice(0, 16);
    };
    initTime();

    // URL builders
    const wmsTiles = (tStrSec, variable) =>
      `http://${HOST}/wms?service=WMS&version=1.3.0&request=GetMap` +
      `&layers=${encodeURIComponent(variable)}` +
      `&width=256&height=256` +
      `&time=${encodeURIComponent(tStrSec)}` +
      `&crs=EPSG:3857&bbox={bbox-epsg-3857}`;

    const tileJSONUrl = (tStrSec, variable) =>
      `http://${HOST}/tiles/WebMercatorQuad/tilejson.json` +
      `?variables=${encodeURIComponent(variable)}` +
      `&width=512&height=512` +
      `&valid_time=${encodeURIComponent(tStrSec)}`;
    
    const styleUrlArgs = (vmin, vmax, colormap) =>
      `&styles=${encodeURIComponent('raster/' + colormap)}` +
      `&colorscalerange=${encodeURIComponent(vmin + ',' + vmax)}`;

    const colormapUrlArgs = (colormap, vmin, vmax) =>
      `&colormap=${encodeURIComponent(colormap)}` +
      `&colorscalerange=${encodeURIComponent(vmin + ',' + vmax)}`;

    // Map
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v11',
      center: [12.5683, 55.6761],
      zoom: 4
    });

    // Source/layer ids
    const SRC_ID = 'ohm-source';
    const LYR_ID = 'ohm-layer';

    const addOrUpdateLayer = () => {
      const src = map.getSource(SRC_ID);
      const layer = map.getLayer(LYR_ID);
      
      colormap_kah = {"-24": "#240026", "-22": "#4f0054", "-20": "#7d008a", "-18": "#b500c4", "-16": "#ed00ff", "-14": "#b200ff", "-12": "#7d00ff", "-10": "#4c00ff", "-8": "#2100ff", "-6": "#0000ff", "-4": "#0d40ff", "-2": "#1c7dff", "0": "#29baff", "2": "#38ffff", "4": "#3dffb5", "6": "#3dff73", "8": "#3df030", "10": "#29d900", "12": "#14c700", "14": "#ffff00", "16": "#fae000", "18": "#fac200", "22": "#f7a300", "24": "#f78700", "26": "#f56b00", "28": "#f54f00", "30": "#f53800", "32": "#f51f00", "34": "#f50000", "36": "#f20000", "38": "#f20021", "40": "#ed0054", "42": "#f5008a"}

      let url = (state.backend === 'wms')
        ? wmsTiles(state.valid_time, state.variable)
        : tileJSONUrl(state.valid_time, state.variable);

      url += (state.colormap === "temperature_colors")
        ? colormapUrlArgs(JSON.stringify(colormap_kah), -24, 42)
        : styleUrlArgs(state.vmin, state.vmax, state.colormap);
      

      if (!src) {
        // create source
        if (state.backend === 'wms') {
          map.addSource(SRC_ID, { type: 'raster', tiles: [url], tileSize: 256 });
        } else {
          map.addSource(SRC_ID, { type: 'raster', url: url });
        }
      } else {
        // update source
        if (state.backend === 'wms') {
          if (src.setTiles) src.setTiles([url]);
          else {
            map.removeSource(SRC_ID);
            map.addSource(SRC_ID, { type: 'raster', tiles: [url], tileSize: 256 });
          }
        } else {
          if (src.setUrl) src.setUrl(url);
          else {
            map.removeSource(SRC_ID);
            map.addSource(SRC_ID, { type: 'raster', url: url });
          }
        }
      }

      if (!layer) {
        map.addLayer({
          id: LYR_ID,
          type: 'raster',
          source: SRC_ID,
          paint: { 'raster-opacity': parseFloat(elOpacity.value) }
        });
      } else {
        map.setPaintProperty(LYR_ID, 'raster-opacity', parseFloat(elOpacity.value));
      }

      map.triggerRepaint();
    };

    const removeLayerAndSource = () => {
      if (map.getLayer(LYR_ID)) map.removeLayer(LYR_ID);
      if (map.getSource(SRC_ID)) map.removeSource(SRC_ID);
    };

    // Map setup
    map.on('load', () => {
      map.setFog({});
      addOrUpdateLayer();
    });

    // UI wiring
    const applyVarDefaults = () => {
      // Simple defaults per variable
      if (state.variable === 't2m') {
        state.vmin = -30; state.vmax = 30;
        state.colormap = 'temperature_colors';
      } else if (state.variable === 'ws10m') {
        state.vmin = 0; state.vmax = 20;
        state.colormap = 'plasma';
      } else {
        state.vmin = -10; state.vmax = 10;
        state.colormap = 'bwr';
      }
      elVmin.value = state.vmin;
      elVmax.value = state.vmax;

      // Update colormap dropdown
      elCmap.value = state.colormap;
      elCmap.selectedIndex = [...elCmap.options].findIndex(option => option.value === state.colormap);
    };

    elBackend.addEventListener('change', (e) => {
      state.backend = e.target.value;
      removeLayerAndSource();
      addOrUpdateLayer();
    });

    elVar.addEventListener('change', (e) => {
      state.variable = e.target.value;
      applyVarDefaults();
      addOrUpdateLayer();
    });

    elCmap.addEventListener('change', (e) => {
      state.colormap = e.target.value;
      addOrUpdateLayer();
    });

    elVmin.addEventListener('change', (e) => {
      const v = parseFloat(e.target.value);
      if (!Number.isNaN(v)) state.vmin = v;
      addOrUpdateLayer();
    });

    elVmax.addEventListener('change', (e) => {
      const v = parseFloat(e.target.value);
      if (!Number.isNaN(v)) state.vmax = v;
      addOrUpdateLayer();
    });

    elOpacity.addEventListener('input', (e) => {
      const v = parseFloat(e.target.value);
      if (map.getLayer(LYR_ID)) {
        map.setPaintProperty(LYR_ID, 'raster-opacity', v);
      }
    });

    elTime.addEventListener('change', (e) => {
      // value is "YYYY-MM-DDTHH:mm" local
      const val = e.target.value;
      const withSec = val.includes(':') && val.length === 16 ? (val + ':00') : val;
      state.valid_time = withSec;
      addOrUpdateLayer();
    });

    elBack3.addEventListener('click', () => {
      const d = parseLocal(state.valid_time);
      const prev = align3h(d, -3);
      state.valid_time = fmtLocalSecond(prev);
      elTime.value = fmtLocalMinute(prev);
      addOrUpdateLayer();
    });

    elFwd3.addEventListener('click', () => {
      const d = parseLocal(state.valid_time);
      const next = align3h(d, +3);
      state.valid_time = fmtLocalSecond(next);
      elTime.value = fmtLocalMinute(next);
      addOrUpdateLayer();
    });

    // Tile boundaries toggle
    let showTiles = false;
    elTileBtn.addEventListener('click', () => {
      showTiles = !showTiles;
      map.showTileBoundaries = showTiles;
      elTileBtn.textContent = showTiles ? 'Hide tile boundaries' : 'Show tile boundaries';
    });

    // Set defaults once variable changes programmatically
    applyVarDefaults();

    // Click popup (debug)
    map.on('style.load', function () {
      map.on('click', function (e) {
        const c = e.lngLat;
        new mapboxgl.Popup()
          .setLngLat(c)
          .setHTML('Clicked: <br/>' + c.lng.toFixed(4) + ', ' + c.lat.toFixed(4))
          .addTo(map);
      });
    });
  </script>
</body>
</html>
